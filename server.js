const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const { GoogleGenerativeAI } = require('@google/generative-ai');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      fontSrc: ["'self'", "https:", "data:"],
      connectSrc: ["'self'"],
      scriptSrcAttr: ["'unsafe-inline'"]
    }
  }
}));
// CORSè¨­å®š - XSERVERå¯¾å¿œ
const corsOptions = {
  origin: function (origin, callback) {
    // é–‹ç™ºç’°å¢ƒã§ã¯å…¨ã¦è¨±å¯
    if (process.env.NODE_ENV !== 'production') {
      return callback(null, true);
    }
    
    // æœ¬ç•ªç’°å¢ƒã§ã¯æŒ‡å®šã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨±å¯
    const allowedOrigins = [
      process.env.CORS_ORIGIN,
      /\.xserver\.jp$/,  // XSERVERã®æ¨™æº–ãƒ‰ãƒ¡ã‚¤ãƒ³
      /\.xsrv\.jp$/,     // XSERVERã®æ¨™æº–ãƒ‰ãƒ¡ã‚¤ãƒ³
      /localhost/,       // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨
    ].filter(Boolean);
    
    if (!origin || allowedOrigins.some(allowed => 
      typeof allowed === 'string' ? allowed === origin : allowed.test(origin)
    )) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};

app.use(cors(corsOptions));
app.use(morgan('combined'));
app.use(express.json({ limit: '10mb' }));
app.use(express.static('public'));

// æ­£ç¢ºãªçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿
let knowledgeBase;
try {
  const knowledgeBasePath = path.join(__dirname, 'accurate-knowledge-base.json');
  knowledgeBase = JSON.parse(fs.readFileSync(knowledgeBasePath, 'utf8'));
  console.log('æ­£ç¢ºãªçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
} catch (error) {
  console.error('æ­£ç¢ºãªçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
  process.exit(1);
}

// Gemini AIã®åˆæœŸåŒ–
let genAI;
let model;

if (process.env.GEMINI_API_KEY) {
  genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
  model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
  console.log('Gemini APIãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
} else {
  console.warn('GEMINI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚');
}

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæŽ¨æ¸¬æƒ…å ±ã‚’æŽ’é™¤ï¼‰
const createPrompt = (userQuestion, knowledge) => {
  return `ã‚ãªãŸã¯ã€Œ${knowledge.companyName}ã€ã®æ­£ç¢ºã§èª å®Ÿãªã‚«ã‚¹ã‚¿ãƒžãƒ¼ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ã§ã™ã€‚
ä»¥ä¸‹ã®å®Ÿéš›ã®ã‚µã‚¤ãƒˆæƒ…å ±ã®ã¿ã«åŸºã¥ã„ã¦ã€ãŠå®¢æ§˜ã®è³ªå•ã«ãŠç­”ãˆãã ã•ã„ã€‚

ã€é‡è¦ãªå›žç­”ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘
1. æä¾›ã•ã‚ŒãŸæƒ…å ±ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å†…å®¹ã®ã¿ã‚’å›žç­”ã™ã‚‹
2. æŽ¨æ¸¬ã‚„ä¸€èˆ¬çš„ãªçŸ¥è­˜ã«ã‚ˆã‚‹å›žç­”ã¯çµ¶å¯¾ã«è¡Œã‚ãªã„
3. æ–™é‡‘ã«ã¤ã„ã¦ã¯ã€Œè¦å•ã„åˆã‚ã›ã€ã§ã‚ã‚‹ã“ã¨ã‚’æ˜Žç¢ºã«ã™ã‚‹
4. è©³ç´°æƒ…å ±ãŒãªã„å ´åˆã¯ã€Œè©³ç´°ã¯ãŠé›»è©±ï¼ˆ${knowledge.contact.phone}ï¼‰ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨æ¡ˆå†…ã™ã‚‹
5. ã€Œæƒ…å ±ãªã—ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹é …ç›®ã«ã¤ã„ã¦ã¯ã€æ­£ç›´ã«æƒ…å ±ãŒãªã„ã“ã¨ã‚’ä¼ãˆã‚‹
6. å¸¸ã«æ¸©ã‹ãã€ç†è§£ã—ã‚„ã™ã„è¨€è‘‰é£ã„ã§å¿œç­”ã™ã‚‹
7. å®Ÿéš›ã®ã‚µã‚¤ãƒˆæƒ…å ±ã«åŸºã¥ã„ãŸæ­£ç¢ºãªå›žç­”ã‚’æœ€å„ªå…ˆã¨ã™ã‚‹

ã€å®Ÿéš›ã®ã‚µã‚¤ãƒˆæƒ…å ±ã€‘
${JSON.stringify(knowledge, null, 2)}

ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- ã“ã®çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å®Ÿéš›ã®ã‚µã‚¤ãƒˆæƒ…å ±ã®ã¿ã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™
- ã‚µã‚¤ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã«ã¤ã„ã¦ã¯æŽ¨æ¸¬ã›ãšã€ãŠå•ã„åˆã‚ã›ã‚’æ¡ˆå†…ã—ã¦ãã ã•ã„
- æ–™é‡‘ã«é–¢ã™ã‚‹è³ªå•ã«ã¯å…·ä½“çš„ãªä¾¡æ ¼å¸¯ã‚’ç¤ºã—ã€ä¼šå“¡åˆ¶åº¦ã«ã¤ã„ã¦ã‚‚èª¬æ˜Žã—ã¦ãã ã•ã„

ã€ãŠå®¢æ§˜ã®è³ªå•ã€‘
${userQuestion}

ã€å›žç­”ã€‘`;
};

// ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å›žç­”ï¼ˆå®Ÿéš›ã®ã‚µã‚¤ãƒˆæƒ…å ±ã®ã¿ï¼‰
const getKeywordResponse = (question) => {
  const lowerQuestion = question.toLowerCase();
  
  // æ–™é‡‘é–¢é€£
  if (lowerQuestion.includes('æ–™é‡‘') || lowerQuestion.includes('è²»ç”¨') || lowerQuestion.includes('ä¾¡æ ¼')) {
    return `ã¨ã­å±‹ã§ã¯å¹…åºƒã„ä¾¡æ ¼å¸¯ã§è‘¬å„€ãƒ—ãƒ©ãƒ³ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ï¼š

ðŸ’° **æ–™é‡‘ä¸€è¦§**
ðŸ”¸ **ç›´è‘¬/ç«è‘¬å¼**: 39,000å††ï½ž184,800å††
   â”” ãƒ—ãƒ©ãƒ³3: 70,000å††ï¼ˆä¼šå“¡39,000å††ï¼‰
   â”” ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ©ãƒ³: 140,800å††ï¼ˆä¼šå“¡128,000å††ï¼‰

ðŸ”¸ **å®¶æ—è‘¬**: 300,000å††ï½ž400,000å††
   â”” ä¸€èˆ¬400,000å†† â†’ ä¼šå“¡300,000å††

ðŸ”¸ **ä¸€æ—¥è‘¬**: 300,000å††ï½ž330,000å††
   â”” é€šå¤œçœç•¥ã®1æ—¥å®Œçµåž‹

ðŸ”¸ **ä¸€èˆ¬è‘¬**: 350,000å††ï½ž410,000å††
   â”” å¾“æ¥ã®2æ—¥é–“å½¢å¼

ðŸ”¸ **è‡ªå®…è‘¬**: 600,000å††ï½ž700,000å††
   â”” ã”è‡ªå®…ã§ã‚†ã£ãã‚Šã¨ãŠè¦‹é€ã‚Š

ðŸ”¸ **ç”Ÿæ´»ä¿è­·è‘¬**: 0å††ï¼ˆè‡ªæ²»ä½“æ‰¶åŠ©ï¼‰

ðŸŽ« **ä¼šå“¡åˆ¶åº¦ã§å¤§å¹…å‰²å¼•**
ãƒ»å…¨ãƒ—ãƒ©ãƒ³ã§ä¼šå“¡ä¾¡æ ¼é©ç”¨
ãƒ»æœ€å¤§100,000å††ä»¥ä¸Šã®å‰²å¼•

è©³ã—ã„ãŠè¦‹ç©ã‚‚ã‚Šã¯ç„¡æ–™ã§æ‰¿ã‚Šã¾ã™ã€‚
ãŠé›»è©±ï¼ˆ0120-000-000ï¼‰ã«ã¦24æ™‚é–“365æ—¥å¯¾å¿œã„ãŸã—ã¾ã™ã€‚`;
  }
  
  // å…·ä½“çš„ãªãƒ—ãƒ©ãƒ³é–¢é€£
  if (lowerQuestion.includes('å®¶æ—è‘¬')) {
    return `**ã¨ã­å±‹ã®å®¶æ—è‘¬**

ðŸ’° **æ–™é‡‘**
ãƒ»ä¸€èˆ¬ä¾¡æ ¼: 400,000å††ï½ž
ãƒ»ä¼šå“¡ä¾¡æ ¼: 300,000å††ï½ž
ãƒ»å‰²å¼•é¡: 100,000å††

ðŸ‘¥ **ç‰¹å¾´**
ãƒ»å®¶æ—ãƒ»è¦ªæ—ä¸­å¿ƒã®å°è¦æ¨¡è‘¬å„€
ãƒ»2æ—¥é–“ï¼ˆé€šå¤œãƒ»å‘Šåˆ¥å¼ï¼‰
ãƒ»æ¸©ã‹ãå¿ƒã®ã“ã‚‚ã£ãŸãŠè¦‹é€ã‚Š

ðŸ“‹ **ãƒ—ãƒ­ã‚»ã‚¹**
1æ—¥ç›®: é€šå¤œ
2æ—¥ç›®: å‘Šåˆ¥å¼ãƒ»ç«è‘¬

ä¼šå“¡åˆ¶åº¦ã§100,000å††ã®å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
è©³ã—ãã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  if (lowerQuestion.includes('ç›´è‘¬') || lowerQuestion.includes('ç«è‘¬å¼')) {
    return `**ç›´è‘¬/ç«è‘¬å¼ãƒ—ãƒ©ãƒ³**

ðŸ’° **æ–™é‡‘ä½“ç³»**
ãƒ»ãƒ—ãƒ©ãƒ³3: 70,000å††ï¼ˆä¼šå“¡39,000å††ï¼‰- æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«
ãƒ»ãƒ—ãƒ©ãƒ³2: 100,000å††ï¼ˆä¼šå“¡89,000å††ï¼‰- åŠæ—¥å®Œäº†
ãƒ»ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ©ãƒ³: 140,800å††ï¼ˆä¼šå“¡128,000å††ï¼‰- No.1äººæ°—
ãƒ»ãƒ™ãƒ¼ã‚·ãƒƒã‚¯: 184,800å††ï¼ˆä¼šå“¡168,000å††ï¼‰- ç´æ£ºè¾¼ã¿

âœ¨ **ç‰¹å¾´**
ãƒ»é€šå¤œãƒ»å‘Šåˆ¥å¼ãªã—ã®æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼
ãƒ»çŸ­æ™‚é–“ã§ã®å®Œäº†
ãƒ»è²»ç”¨ã‚’æŠ‘ãˆãŸã„æ–¹ã«ãŠã™ã™ã‚

ðŸ“‹ **åŸºæœ¬ã®æµã‚Œ**
ã”é€åŽ» â†’ ãŠè¿Žãˆ â†’ ç«è‘¬

è©³ã—ã„ãƒ—ãƒ©ãƒ³å†…å®¹ã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  if (lowerQuestion.includes('ä¸€æ—¥è‘¬')) {
    return `**ã¨ã­å±‹ã®ä¸€æ—¥è‘¬**

ðŸ’° **æ–™é‡‘**
ãƒ»ä¸€èˆ¬ä¾¡æ ¼: 330,000å††ï½ž
ãƒ»ä¼šå“¡ä¾¡æ ¼: 300,000å††ï½ž

âœ¨ **ç‰¹å¾´**
ãƒ»é€šå¤œã‚’çœç•¥ã—ãŸ1æ—¥å®Œçµåž‹
ãƒ»ãŠã™ã™ã‚ãƒ—ãƒ©ãƒ³
ãƒ»æ™‚é–“çš„è² æ‹…ã‚’è»½æ¸›

ðŸ“‹ **ãƒ—ãƒ­ã‚»ã‚¹**
å‘Šåˆ¥å¼ã®ã¿ã‚’1æ—¥ã§åŸ·ã‚Šè¡Œã„ã¾ã™

ä¼šå“¡åˆ¶åº¦ã§30,000å††ã®å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
è©³ã—ãã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  if (lowerQuestion.includes('ä¸€èˆ¬è‘¬')) {
    return `**ã¨ã­å±‹ã®ä¸€èˆ¬è‘¬**

ðŸ’° **æ–™é‡‘**
ãƒ»ä¸€èˆ¬ä¾¡æ ¼: 410,000å††ï½ž
ãƒ»ä¼šå“¡ä¾¡æ ¼: 350,000å††ï½ž

âœ¨ **ç‰¹å¾´**
ãƒ»å¾“æ¥ã®é€šå¤œãƒ»å‘Šåˆ¥å¼ã‚’è¡Œã†å½¢å¼
ãƒ»ä¸€èˆ¬çš„ãªè‘¬å„€ã‚’ä½Žä¾¡æ ¼ã§æä¾›
ãƒ»å¤šãã®æ–¹ã«ã”å‚åˆ—ã„ãŸã ã‘ã‚‹

ðŸ“‹ **ãƒ—ãƒ­ã‚»ã‚¹**
1æ—¥ç›®: é€šå¤œ
2æ—¥ç›®: å‘Šåˆ¥å¼ãƒ»ç«è‘¬

ä¼šå“¡åˆ¶åº¦ã§60,000å††ã®å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
è©³ã—ãã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  if (lowerQuestion.includes('è‡ªå®…è‘¬')) {
    return `**è‡ªå®…è‘¬**

ðŸ’° **æ–™é‡‘**
ãƒ»ä¸€èˆ¬ä¾¡æ ¼: 700,000å††ï½ž
ãƒ»ä¼šå“¡ä¾¡æ ¼: 600,000å††ï½ž

âœ¨ **ç‰¹å¾´**
ãƒ»æ•…äººã®ä½ã¿æ…£ã‚ŒãŸè‡ªå®…ã§åŸ·ã‚Šè¡Œã†
ãƒ»ã‚†ã£ãã‚Šã¨ãŠè¦‹é€ã‚ŠãŒã§ãã‚‹
ãƒ»å®¶æ—ã§ã‚†ã£ãã‚Šã¨éŽã”ã›ã‚‹

ðŸ“‹ **ãƒ—ãƒ­ã‚»ã‚¹**
è‡ªå®…ã§ã‚†ã£ãã‚ŠãŠè¦‹é€ã‚Šï¼ˆ2æ—¥é–“ï¼‰

ä¼šå“¡åˆ¶åº¦ã§100,000å††ã®å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚
è©³ã—ãã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  if (lowerQuestion.includes('ç”Ÿæ´»ä¿è­·') || lowerQuestion.includes('ç¦ç¥‰è‘¬')) {
    return `**ç”Ÿæ´»ä¿è­·è‘¬ï¼ˆç¦ç¥‰ãƒ—ãƒ©ãƒ³ï¼‰**

ðŸ’° **æ–™é‡‘**
ãƒ»è‡ªå·±è² æ‹…: 0å††
ãƒ»è‡ªæ²»ä½“æ‰¶åŠ©ãŒé©ç”¨ã•ã‚Œã¾ã™

âœ… **å¯¾è±¡è€…**
ãƒ»ç”Ÿæ´»ä¿è­·å—çµ¦è€…ã®ã¿

ðŸ“‹ **ãƒ—ãƒ­ã‚»ã‚¹**
ãŠè¿Žãˆ â†’ ã”å®‰ç½® â†’ ç´æ£º â†’ ç«è‘¬ â†’ åŽéª¨

ðŸ”¸ å¿…è¦æœ€å°é™ã®å†…å®¹ã§å°ŠåŽ³ã‚’ä¿ã£ãŸè‘¬å„€
ðŸ”¸ è‡ªæ²»ä½“ã¨ã®æ‰‹ç¶šãã‚‚ä»£è¡Œã„ãŸã—ã¾ã™

è©³ã—ãã¯0120-000-000ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`;
  }
  
  // ä¼šå“¡åˆ¶åº¦é–¢é€£
  if (lowerQuestion.includes('ä¼šå“¡') || lowerQuestion.includes('å‰²å¼•') || lowerQuestion.includes('ä¼šå“¡åˆ¶åº¦')) {
    return `**ã¨ã­å±‹ã®ä¼šå“¡åˆ¶åº¦**

ðŸŽ« **ä¼šå“¡ç‰¹å…¸**
ãƒ»å…¨ãƒ—ãƒ©ãƒ³ã§ä¼šå“¡ä¾¡æ ¼ãŒé©ç”¨ã•ã‚Œã¾ã™
ãƒ»å¤§å¹…ãªå‰²å¼•ã§ãŠå¾—ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™

ðŸ’° **å‰²å¼•ä¾‹**
ãƒ»ç›´è‘¬ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ©ãƒ³: 140,800å†† â†’ 128,000å††ï¼ˆ12,800å††å‰²å¼•ï¼‰
ãƒ»å®¶æ—è‘¬: 400,000å†† â†’ 300,000å††ï¼ˆ100,000å††å‰²å¼•ï¼‰
ãƒ»ä¸€èˆ¬è‘¬: 410,000å†† â†’ 350,000å††ï¼ˆ60,000å††å‰²å¼•ï¼‰
ãƒ»è‡ªå®…è‘¬: 700,000å†† â†’ 600,000å††ï¼ˆ100,000å††å‰²å¼•ï¼‰

âœ… **ãã®ä»–ã®ç‰¹å…¸**
ãƒ»ç„¡æ–™ç›¸è«‡ã‚µãƒ¼ãƒ“ã‚¹å„ªå…ˆå¯¾å¿œ
ãƒ»24æ™‚é–“365æ—¥ã‚µãƒãƒ¼ãƒˆ
ãƒ»äº‹å‰ç›¸è«‡ã§å®‰å¿ƒ

ðŸ“ž **å…¥ä¼šãƒ»è©³ç´°ã«ã¤ã„ã¦**
ä¼šå“¡åˆ¶åº¦ã®è©³ç´°ã‚„ã”å…¥ä¼šã«ã¤ã„ã¦ã¯ã€
ãŠé›»è©±ï¼ˆ0120-000-000ï¼‰ã«ã¦ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚`;
  }
  
  // ãƒ—ãƒ©ãƒ³é–¢é€£
  if (lowerQuestion.includes('ãƒ—ãƒ©ãƒ³') || lowerQuestion.includes('ç¨®é¡ž')) {
    return `ã¨ã­å±‹ã§ã¯è±Šå¯Œãªè‘¬å„€ãƒ—ãƒ©ãƒ³ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ï¼š

ðŸ“‹ **ãƒ—ãƒ©ãƒ³ä¸€è¦§**

**ðŸ”¸ ç›´è‘¬/ç«è‘¬å¼ï¼ˆ39,000å††ï½žï¼‰**
ãƒ»ãƒ—ãƒ©ãƒ³3: 70,000å††ï¼ˆä¼šå“¡39,000å††ï¼‰- æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«
ãƒ»ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ©ãƒ³: 140,800å††ï¼ˆä¼šå“¡128,000å††ï¼‰- No.1äººæ°—

**ðŸ”¸ å®¶æ—è‘¬ï¼ˆ300,000å††ï½žï¼‰**
ãƒ»å®¶æ—ãƒ»è¦ªæ—ä¸­å¿ƒã®2æ—¥é–“ã®è‘¬å„€
ãƒ»ä¸€èˆ¬400,000å†† â†’ ä¼šå“¡300,000å††

**ðŸ”¸ ä¸€æ—¥è‘¬ï¼ˆ300,000å††ï½žï¼‰**
ãƒ»é€šå¤œã‚’çœç•¥ã—ãŸ1æ—¥å®Œçµåž‹
ãƒ»ãŠã™ã™ã‚ãƒ—ãƒ©ãƒ³

**ðŸ”¸ ä¸€èˆ¬è‘¬ï¼ˆ350,000å††ï½žï¼‰**
ãƒ»å¾“æ¥ã®é€šå¤œãƒ»å‘Šåˆ¥å¼ã‚’è¡Œã†å½¢å¼
ãƒ»ä¸€èˆ¬410,000å†† â†’ ä¼šå“¡350,000å††

**ðŸ”¸ è‡ªå®…è‘¬ï¼ˆ600,000å††ï½žï¼‰**
ãƒ»æ•…äººã®ä½ã¿æ…£ã‚ŒãŸè‡ªå®…ã§
ãƒ»ä¸€èˆ¬700,000å†† â†’ ä¼šå“¡600,000å††

**ðŸ”¸ ç”Ÿæ´»ä¿è­·è‘¬ï¼ˆ0å††ï¼‰**
ãƒ»ç”Ÿæ´»ä¿è­·å—çµ¦è€…å°‚ç”¨
ãƒ»è‡ªæ²»ä½“æ‰¶åŠ©ã§è‡ªå·±è² æ‹…ãªã—

**ðŸ”¸ ç¤¾è‘¬ï¼ˆ1,000ä¸‡å††ï½žï¼‰**
ãƒ»ä¼æ¥­ãƒ»å›£ä½“ä¸»å‚¬ã®å¤§è¦æ¨¡è‘¬å„€

ðŸ’¡ **ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒ³ã§ä¼šå“¡åˆ¶åº¦ã«ã‚ˆã‚‹å‰²å¼•ã‚ã‚Š**

è©³ç´°ãªãƒ—ãƒ©ãƒ³å†…å®¹ã¯ã€ãŠé›»è©±ï¼ˆ0120-000-000ï¼‰ã«ã¦
å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ãŒã”èª¬æ˜Žã„ãŸã—ã¾ã™ã€‚`;
  }
  
  // å¼å ´é–¢é€£
  if (lowerQuestion.includes('å¼å ´') || lowerQuestion.includes('ãƒ›ãƒ¼ãƒ«') || lowerQuestion.includes('å ´æ‰€')) {
    return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€è‡ªç¤¾å¼å ´ã®è©³ç´°ãªæƒ…å ±ã«ã¤ã„ã¦ã¯ã€ã‚µã‚¤ãƒˆã«è¨˜è¼‰ãŒã”ã–ã„ã¾ã›ã‚“ã€‚

ðŸ“ å¯¾å¿œã‚¨ãƒªã‚¢
- æ±äº¬éƒ½ï¼ˆ23åŒºå…¨ä½“ãŠã‚ˆã³ãã®ä»–ã®åœ°åŸŸï¼‰
- ç¥žå¥ˆå·çœŒï¼ˆæ¨ªæµœå¸‚ã€å·å´Žå¸‚ã€ç›¸æ¨¡åŽŸå¸‚ãªã©ï¼‰

å¼å ´ã®è©³ç´°æƒ…å ±ã«ã¤ã„ã¦ã¯ã€ãŠé›»è©±ï¼ˆ0120-000-000ï¼‰ã«ã¦
å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ãŒä¸å¯§ã«ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚`;
  }
  
  // ç·Šæ€¥æ™‚å¯¾å¿œ
  if (lowerQuestion.includes('ç·Šæ€¥') || lowerQuestion.includes('ä»Šã™ã') || lowerQuestion.includes('æ€¥')) {
    return `ç·Šæ€¥æ™‚ã¯24æ™‚é–“365æ—¥å¯¾å¿œã„ãŸã—ã¾ã™ã€‚

ðŸš¨ ä»Šã™ããŠé›»è©±ãã ã•ã„
â˜Žï¸ 0120-000-000

âœ… é€šè©±ç„¡æ–™
âœ… å¹´ä¸­ç„¡ä¼‘
âœ… ãƒ•ãƒªãƒ¼ãƒ€ã‚¤ãƒ¤ãƒ«

ç·Šæ€¥æ™‚ã®è©³ç´°ãªå¯¾å¿œã«ã¤ã„ã¦ã¯ã€ãŠé›»è©±ã«ã¦
å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ãŒè¿…é€Ÿã«ã”å¯¾å¿œã„ãŸã—ã¾ã™ã€‚`;
  }
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
  return `ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

å½“ç¤¾ã§ã¯ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ãŠã‚Šã¾ã™ï¼š
ðŸ”¸ å„ç¨®è‘¬å„€ãƒ—ãƒ©ãƒ³
ðŸ”¸ å®—æ•™ãƒ»å®—æ´¾ã«å¿œã˜ãŸè‘¬å„€ï¼ˆä»å¼ã€ç¥žå¼ã€ã‚­ãƒªã‚¹ãƒˆæ•™ã€å‰µä¾¡å­¦ä¼šã€ç„¡å®—æ•™ï¼‰
ðŸ”¸ äº‹å‰ç›¸è«‡ã‚µãƒ¼ãƒ“ã‚¹
ðŸ”¸ ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒãƒ¼ãƒˆ

è©³ã—ã„æƒ…å ±ã«ã¤ã„ã¦ã¯ã€å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ãŒä¸å¯§ã«ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚

ðŸ“ž 24æ™‚é–“365æ—¥å¯¾å¿œ
â˜Žï¸ 0120-000-000

ãŠæ°—è»½ã«ãŠé›»è©±ãã ã•ã„ã€‚`;
};

// ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/chat', async (req, res) => {
  try {
    const { question } = req.body;
    
    if (!question || question.trim() === '') {
      return res.status(400).json({ 
        error: 'Question is required',
        message: 'è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' 
      });
    }
    
    let answer;
    
    if (model && process.env.GEMINI_API_KEY) {
      try {
        // AI APIã‚’ä½¿ç”¨ã—ã¦å›žç­”ã‚’ç”Ÿæˆ
        const prompt = createPrompt(question, knowledgeBase);
        const result = await model.generateContent(prompt);
        const response = await result.response;
        answer = response.text();
        
        // å›žç­”ãŒç©ºã¾ãŸã¯ä¸é©åˆ‡ãªå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (!answer || answer.trim() === '' || answer.includes('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“')) {
          answer = getKeywordResponse(question);
        }
        
      } catch (aiError) {
        console.error('AI API Error:', aiError);
        // AI APIãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å›žç­”ã‚’ä½¿ç”¨
        answer = getKeywordResponse(question);
      }
    } else {
      // API KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å›žç­”ã‚’ä½¿ç”¨
      answer = getKeywordResponse(question);
    }
    
    res.json({ 
      answer: answer,
      timestamp: new Date().toISOString(),
      source: model ? 'ai' : 'keyword'
    });
    
  } catch (error) {
    console.error('Chat API Error:', error);
    res.status(500).json({ 
      error: 'Internal server error',
      message: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
    });
  }
});

// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK',
    timestamp: new Date().toISOString(),
    aiAvailable: !!model,
    knowledgeBaseLoaded: !!knowledgeBase
  });
});

// çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆé–‹ç™ºç”¨ï¼‰
app.get('/api/knowledge', (req, res) => {
  res.json({
    companyName: knowledgeBase.companyName,
    contact: knowledgeBase.contact,
    serviceAreas: knowledgeBase.serviceAreas,
    planCount: knowledgeBase.plans.length,
    hallCount: knowledgeBase.funeralHalls.length,
    faqCount: knowledgeBase.frequentlyAskedQuestions.reduce((count, category) => 
      count + category.questions.length, 0
    )
  });
});

// é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®æä¾›
app.use(express.static('.'));

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ 
    error: 'Something went wrong!',
    message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' 
  });
});

// 404ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.use((req, res) => {
  res.status(404).json({ 
    error: 'Not Found',
    message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' 
  });
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
app.listen(PORT, () => {
  console.log(`ðŸš€ Server is running on port ${PORT}`);
  console.log(`ðŸ“Š Health check: http://localhost:${PORT}/api/health`);
  console.log(`ðŸ’¬ Chat endpoint: http://localhost:${PORT}/api/chat`);
  console.log(`ðŸ“š Knowledge base: http://localhost:${PORT}/api/knowledge`);
  
  if (!process.env.GEMINI_API_KEY) {
    console.log('âš ï¸  GEMINI_API_KEY is not set. Using keyword-based responses only.');
    console.log('   To enable AI responses, set GEMINI_API_KEY in your .env file.');
  }
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down gracefully');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down gracefully');
  process.exit(0);
});

module.exports = app;